<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>RAG Chat Storage - Documents</title>
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body>
<div class="app">
    <aside class="sidebar">
        <div class="header" style="flex-direction:column;align-items:flex-start;gap:10px">
            <div class="brand">RAG Chat Storage</div>
            <form method="get" th:action="@{/ui/docs}" style="display:flex;gap:6px;align-items:center;width:100%">
                <input type="text" name="userId" id="userIdInput" th:placeholder="${userId}" style="flex:1" list="userIdSuggestions" autocomplete="off" />
                <datalist id="userIdSuggestions"></datalist>
                <button class="secondary" type="submit" title="Switch user">Switch</button>
            </form>
            <span class="badge" th:text="${userId}">user</span>
        </div>
        <div class="new-session">
            <a class="btn secondary" th:href="@{/ui/sessions(userId=${userId})}">← Back to chats</a>
        </div>
    </aside>
    <main class="main">
        <div class="topbar">
            <button class="menu-btn" type="button" id="menuToggle" aria-label="Open menu">☰</button>
            <div class="title">Documents</div>
            <div class="utilities">
                <a href="/docs" class="btn secondary">API Docs</a>
            </div>
        </div>
        <div class="chat" style="padding:16px">
            <div style="display:grid;grid-template-columns:1fr;gap:16px;max-width:920px;margin:auto">
                <section class="card">
                    <h3>Upsert document</h3>
                    <form id="docUpsertForm" style="display:flex;flex-direction:column;gap:8px">
                        <input type="hidden" name="userId" th:value="${userId}">
                        <label>Text<br>
                            <textarea name="text" rows="4" placeholder="Paste text to index..." required></textarea>
                        </label>
                        <label>Metadata (JSON string optional)<br>
                            <input type="text" name="metadata" placeholder='{"source":"note"}'>
                        </label>
                        <div>
                            <button type="submit" class="btn">Upsert</button>
                            <span id="upsertStatus" class="badge" style="display:none"></span>
                        </div>
                    </form>
                </section>
                <section class="card">
                    <h3>Semantic search</h3>
                    <form id="docSearchForm" style="display:flex;flex-direction:column;gap:8px">
                        <input type="hidden" name="userId" th:value="${userId}">
                        <label>Query<br>
                            <input type="text" name="query" placeholder="Search..." required>
                        </label>
                        <label>Top K<br>
                            <input type="number" name="topK" min="1" max="50" value="5">
                        </label>
                        <div>
                            <button type="submit" class="btn">Search</button>
                        </div>
                    </form>
                    <div id="searchResults" style="margin-top:12px"></div>
                </section>
            </div>
        </div>
    </main>
</div>
<script th:src="@{/js/ui.js}"></script>
<script>
(function(){
  const upsertForm = document.getElementById('docUpsertForm');
  const statusEl = document.getElementById('upsertStatus');
  const apiKeyHeader = 'X-API-KEY';
  const apiKey = (localStorage && localStorage.getItem('apiKey')) || '';
  function setStatus(msg, ok){ if(!statusEl) return; statusEl.textContent = msg; statusEl.style.display='inline-block'; statusEl.className = 'badge ' + (ok? '': 'danger'); }
  if (upsertForm){
    upsertForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(upsertForm);
      const body = { userId: fd.get('userId') || undefined, text: fd.get('text') || '', metadata: fd.get('metadata') || undefined };
      try {
        const resp = await fetch('/api/v1/docs/upsert', { method:'POST', headers:{ 'Content-Type':'application/json', [apiKeyHeader]: apiKey }, body: JSON.stringify(body)});
        if (!resp.ok) { const txt = await resp.text(); setStatus('Failed: ' + txt, false); return; }
        const json = await resp.json();
        setStatus('Stored id ' + json.id + ' (dims ' + json.dimensions + ')', true);
        upsertForm.reset();
      } catch(err){ setStatus('Error: ' + (err && err.message ? err.message: 'unknown'), false); }
    });
  }
  const searchForm = document.getElementById('docSearchForm');
  const results = document.getElementById('searchResults');
  if (searchForm && results){
    searchForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(searchForm);
      const body = {
        query: fd.get('query') || '',
        userId: fd.get('userId') || undefined,
        topK: parseInt(fd.get('topK') || '5', 10)
      };
      try{
        const resp = await fetch('/api/v1/docs/search', { method:'POST', headers:{ 'Content-Type':'application/json', [apiKeyHeader]: apiKey }, body: JSON.stringify(body)});
        const txt = await resp.text();
        if (!resp.ok){ results.innerHTML = '<div class="muted">Failed: ' + txt.replace(/</g,'&lt;') + '</div>'; return; }
        const json = JSON.parse(txt);
        const list = Array.isArray(json.matches) ? json.matches : [];
        if (list.length === 0){ results.innerHTML = '<div class="muted">No results</div>'; return; }
        results.innerHTML = list.map(m => (
          '<div class="msg" style="padding:12px">'
          + '<div style="font-size:12px;color:var(--muted)">ID ' + m.id + ' • score ' + (Math.round(m.score*1000)/1000) + '</div>'
          + '<div style="white-space:pre-wrap">' + (m.text ? m.text.replace(/</g,'&lt;') : '') + '</div>'
          + (m.metadata ? ('<pre class="context">' + String(m.metadata).replace(/</g,'&lt;') + '</pre>') : '')
          + '</div>'
        )).join('');
      } catch(err){ results.innerHTML = '<div class="muted">Error: ' + (err && err.message ? err.message: 'unknown') + '</div>'; }
    });
  }
})();
</script>
</body>
</html>