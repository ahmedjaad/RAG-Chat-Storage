# RAG Chat Storage

A production-ready microservice to store chat histories generated by a RAG-based chatbot system.

## Features
- Manage chat sessions (create, rename, favorite, delete)
- Store messages with sender, content, and optional context
- Pagination for messages
- API Key authentication (header: `X-API-KEY`)
- Simple rate limiting per API key / IP
- Global error handling and centralized logging baseline
- Health checks via Spring Boot Actuator
- OpenAPI/Swagger UI
- Dockerized with MySQL and Adminer

## Tech Stack
- Java 21, Spring Boot 3
- Spring Web, Spring Data JPA, MySQL
- Springdoc OpenAPI, Actuator

## Getting Started

### Prerequisites
- Docker and Docker Compose

### Environment Variables
Copy `.env.example` to `.env` and adjust as needed.

```
cp .env.example .env
```

- Local runs: .env is automatically loaded at startup (via spring-dotenv), so you don‚Äôt need to export variables manually.
- Docker Compose: docker compose automatically reads .env in the project root; the app service is configured with `env_file: .env`.

Key variables:
- `API_KEY` ‚Äì required to access APIs
- `DB_URL`, `DB_USERNAME`, `DB_PASSWORD` ‚Äì MySQL connection

### Run with Docker Compose
```
docker compose up --build
```
- App: http://localhost:8080 (container name: rag-app)
- Adminer: http://localhost:8081 (container name: rag-adminer)
  - Adminer connection to MySQL:
    - System: MySQL
    - Server: mysql (service hostname inside Compose network) or rag-mysql (container name)
    - User: root
    - Password: value of MYSQL_ROOT_PASSWORD in your .env (default: secret)
  - If you see "Connection refused" in Adminer:
    - Wait a few seconds; MySQL has a healthcheck and Adminer will start after it‚Äôs healthy.
    - Ensure you connect to Server: mysql (service) or rag-mysql (container), not localhost.
    - Check that host port 3306 isn‚Äôt already used by a local MySQL. If in use, edit docker-compose.yml and change the mapping to "3307:3306", then restart.
- MySQL (container name: rag-mysql) is available on host port 3306 by default.
- Health: http://localhost:8080/actuator/health (details enabled)
  - Liveness: http://localhost:8080/actuator/health/liveness
  - Readiness: http://localhost:8080/actuator/health/readiness
- Swagger UI: http://localhost:8080/swagger-ui/index.html
- Docs shortcut: http://localhost:8080/docs
- Simple UI (Thymeleaf): http://localhost:8080/ui (defaults to userId=demo if you hit /ui)
- Friendly UI error pages for not found (404) and general errors

Add header `X-API-KEY: <your api key>` to API requests.

Troubleshooting 401 Unauthorized:
- Ensure you set API_KEY in your .env and restarted the app. The default is `changeme`.
- Send header name exactly as configured: by default `X-API-KEY`. You can change the header name with `security.api-key.header`.
- Using the included .http files, define @API_KEY or http-client.env.json with API_KEY.
- Public endpoints (no key required): `/`, `/actuator/health`, `/docs`, `/swagger-ui/**`, `/ui/**`, and static assets (`/css/**`, `/js/**`, `/images/**`, `/webjars/**`).

## API

Base path: `/api/v1`

### Users
- POST `/api/v1/users` ‚Äì create (or ensure) a user
  - Body: `{ "userId": "u1" }`
- GET `/api/v1/users` ‚Äì list users

### Sessions
- POST `/api/v1/sessions` ‚Äì create session
  - Body: `{ "userId": "u1", "title": "My chat" }`
- GET `/api/v1/sessions?userId=u1&favorite=true|false&page=0&size=20&q=term` ‚Äì list sessions for user (paginated, optional favorite, optional `q` for title contains; ordered by updatedAt desc)
- PATCH `/api/v1/sessions/{id}/title` ‚Äì rename session
  - Body: `{ "title": "New title" }`
- PATCH `/api/v1/sessions/{id}/favorite` ‚Äì mark/unmark favorite
  - Body: `{ "favorite": true }`
- DELETE `/api/v1/sessions/{id}` ‚Äì delete session and messages

### Messages
- POST `/api/v1/sessions/{id}/messages` ‚Äì add message
  - Body: `{ "sender": "USER|ASSISTANT|SYSTEM", "content": "...", "context": "..." }`
- GET `/api/v1/sessions/{id}/messages?page=0&size=20` ‚Äì list messages (paginated)

## UI

A built-in Thymeleaf UI is available at /ui with a ChatGPT-like dark theme and responsive layout:
- Left sidebar lists sessions with small, friendly controls per session (favorite ‚≠ê/‚òÜ, inline rename ‚úé, delete üóë), and a filter toggle (All / Favorites)
- Main chat area shows messages with alternating bubbles
- Sticky composer at the bottom to send USER messages quickly
- Now, when you send a message, the server calls OpenAI via Spring AI and posts the assistant reply back into the same session (requires OPENAI_API_KEY set). If the AI is unavailable or misconfigured, the UI shows a subtle notice instead of an error in the chat.

Tip: Open http://localhost:8080/ui to get redirected to a demo user (userId=demo).

Mobile: On small screens, use the ‚ò∞ button in the top bar to open/close the sessions sidebar.

## Correlating logs via X-Request-Id

This service emits structured JSON logs (Logback + logstash encoder). Each request receives a requestId that is:
- Accepted from the incoming header X-Request-Id, or generated if absent
- Added to MDC as requestId and returned as X-Request-Id response header
- Included in all log events for that request, including a single access log line with method, path, status, and duration

To trace a request end-to-end:
- Send a header: X-Request-Id: <your-id> (optional)
- Or take the X-Request-Id from the response header
- Filter your logs by {"requestId":"..."}

Example curl:

curl -i http://localhost:8080/api/v1/sessions?userId=demo \\
  -H "X-API-KEY: $API_KEY" \\
  -H "X-Request-Id: demo-req-123"

You will see one access log entry with that requestId.

## Development

Build & test:
```
mvn clean package
```

Run locally:
```
cp .env.example .env   # first time only
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev
```

## Notes
- CORS is configurable via environment vars.
- Rate limiter uses a simple in-memory fixed-window; for production consider Redis or Bucket4j.


## AI (Spring AI)

This service integrates Spring AI for chat inference and embeddings using OpenAI-compatible models.

- Env vars:
  - OPENAI_API_KEY ‚Äì required
  - OPENAI_BASE_URL ‚Äì default https://api.openai.com (set to an OpenAI-compatible endpoint if needed)
  - OPENAI_CHAT_MODEL ‚Äì default gpt-4o-mini
  - OPENAI_EMBED_MODEL ‚Äì default text-embedding-3-small

### Endpoints
- POST /api/v1/ai/infer
  - Body: { "prompt": "Hello", "system": "You are a helpful assistant." }
  - Response: { "content": "...", "metadata": { ... } }
- POST /api/v1/ai/embeddings
  - Body: { "inputs": ["text 1", "text 2"] }
  - Response: { "data": [{"vector": [..]}, ...], "dimensions": 1536 }

Note: These endpoints require the API key header like other APIs (X-API-KEY).
