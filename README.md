# RAG Chat Storage

A production-ready microservice to store chat histories generated by a RAG-based chatbot system.

## Features
- Manage chat sessions (create, rename, favorite, delete)
- Store messages with sender, content, and optional context
- Pagination for messages
- API Key authentication (header: `X-API-KEY`)
- Simple rate limiting per API key / IP
- Global error handling and centralized logging baseline
- Health checks via Spring Boot Actuator
- OpenAPI/Swagger UI
- Dockerized with MySQL and Adminer

## Tech Stack
- Java 21, Spring Boot 3
- Spring Web, Spring Data JPA, MySQL
- Springdoc OpenAPI, Actuator

## Getting Started

### Prerequisites
- Docker and Docker Compose

### Environment Variables
Copy `.env.example` to `.env` and adjust as needed.

```
cp .env.example .env
```

- Local runs: .env is automatically loaded at startup (via spring-dotenv), so you don’t need to export variables manually.
- Docker Compose: docker compose automatically reads .env in the project root; the app service is configured with `env_file: .env`.

Key variables:
- `API_KEY` – required to access APIs
- `DB_URL`, `DB_USERNAME`, `DB_PASSWORD` – MySQL connection

### Run with Docker Compose
```
docker compose up --build
```
- App: http://localhost:8080
- Adminer: http://localhost:8081 (System: MySQL, Server: mysql, User: root, Password: secret)
- Health: http://localhost:8080/actuator/health (details enabled)
  - Liveness: http://localhost:8080/actuator/health/liveness
  - Readiness: http://localhost:8080/actuator/health/readiness
- Swagger UI: http://localhost:8080/swagger-ui/index.html
- Docs shortcut: http://localhost:8080/docs
- Simple UI (Thymeleaf): http://localhost:8080/ui (defaults to userId=demo if you hit /ui)

Add header `X-API-KEY: <your api key>` to API requests.

## API

Base path: `/api/v1`

### Sessions
- POST `/api/v1/sessions` – create session
  - Body: `{ "userId": "u1", "title": "My chat" }`
- GET `/api/v1/sessions?userId=u1` – list sessions for user
- PATCH `/api/v1/sessions/{id}/title` – rename session
  - Body: `{ "title": "New title" }`
- PATCH `/api/v1/sessions/{id}/favorite` – mark/unmark favorite
  - Body: `{ "favorite": true }`
- DELETE `/api/v1/sessions/{id}` – delete session and messages

### Messages
- POST `/api/v1/sessions/{id}/messages` – add message
  - Body: `{ "sender": "USER|ASSISTANT|SYSTEM", "content": "...", "context": "..." }`
- GET `/api/v1/sessions/{id}/messages?page=0&size=20` – list messages (paginated)

## UI

A minimal server-side rendered UI is included using Thymeleaf under /ui to allow quick manual testing without an API client. It uses the same service layer as the REST API and runs in the same JVM.

## Development

Build & test:
```
mvn clean package
```

Run locally:
```
cp .env.example .env   # first time only
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev
```

## Notes
- CORS is configurable via environment vars.
- Rate limiter uses a simple in-memory fixed-window; for production consider Redis or Bucket4j.


## AI (Spring AI)

This service integrates Spring AI for chat inference and embeddings using OpenAI-compatible models.

- Env vars:
  - OPENAI_API_KEY – required
  - OPENAI_BASE_URL – default https://api.openai.com (set to an OpenAI-compatible endpoint if needed)
  - OPENAI_CHAT_MODEL – default gpt-4o-mini
  - OPENAI_EMBED_MODEL – default text-embedding-3-small

### Endpoints
- POST /api/v1/ai/infer
  - Body: { "prompt": "Hello", "system": "You are a helpful assistant." }
  - Response: { "content": "...", "metadata": { ... } }
- POST /api/v1/ai/embeddings
  - Body: { "inputs": ["text 1", "text 2"] }
  - Response: { "data": [{"vector": [..]}, ...], "dimensions": 1536 }

Note: These endpoints require the API key header like other APIs (X-API-KEY).
