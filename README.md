# RAG Chat Storage

A production-ready microservice to store chat histories generated by a RAG-based chatbot system.

## Features
- Manage chat sessions (create, rename, favorite, delete)
- Store messages with sender, content, and optional context
- Pagination for messages
- API Key authentication (header: `X-API-KEY`)
- Simple rate limiting per API key / IP
- Global error handling and centralized logging baseline
- Health checks via Spring Boot Actuator
- OpenAPI/Swagger UI
- Dockerized with MySQL and Adminer

## Tech Stack
- Java 21, Spring Boot 3
- Spring Web, Spring Data JPA, MySQL
- Springdoc OpenAPI, Actuator

## Getting Started

### Prerequisites
- Docker and Docker Compose

### Environment Variables
Copy `.env.example` to `.env` and adjust as needed.

```
cp .env.example .env
```

Key variables:
- `API_KEY` – required to access APIs
- `DB_URL`, `DB_USERNAME`, `DB_PASSWORD` – MySQL connection

### Run with Docker Compose
```
docker compose up --build
```
- App: http://localhost:8080
- Adminer: http://localhost:8081 (System: MySQL, Server: mysql, User: root, Password: secret)
- Health: http://localhost:8080/actuator/health
- Swagger UI: http://localhost:8080/swagger-ui/index.html

Add header `X-API-KEY: <your api key>` to API requests.

## API

Base path: `/api/v1`

### Sessions
- POST `/api/v1/sessions` – create session
  - Body: `{ "userId": "u1", "title": "My chat" }`
- GET `/api/v1/sessions?userId=u1` – list sessions for user
- PATCH `/api/v1/sessions/{id}/title` – rename session
  - Body: `{ "title": "New title" }`
- PATCH `/api/v1/sessions/{id}/favorite` – mark/unmark favorite
  - Body: `{ "favorite": true }`
- DELETE `/api/v1/sessions/{id}` – delete session and messages

### Messages
- POST `/api/v1/sessions/{id}/messages` – add message
  - Body: `{ "sender": "USER|ASSISTANT|SYSTEM", "content": "...", "context": "..." }`
- GET `/api/v1/sessions/{id}/messages?page=0&size=20` – list messages (paginated)

## Development

Build & test:
```
mvn clean package
```

Run locally:
```
export API_KEY=changeme
export DB_URL=jdbc:mysql://localhost:3306/rag_chat_storage
export DB_USERNAME=root
export DB_PASSWORD=secret
mvn spring-boot:run
```

## Notes
- CORS is configurable via environment vars.
- Rate limiter uses a simple in-memory fixed-window; for production consider Redis or Bucket4j.
